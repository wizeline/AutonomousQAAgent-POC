name: Run Uploaded Tests

on:
  push:
    paths:
      - 'artifacts/**/*.tar.gz'
      - 'artifacts/**/*.zip'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-uploaded-tests:
    name: Unpack & Execute Uploaded Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find uploaded archive
        id: find
        run: |
          # Find the most recent archive in artifacts/
          file=$(find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) | sort | tail -n 1)
          if [ -z "$file" ]; then
            echo "❌ No archive found in artifacts/"
            exit 1
          fi
          echo "Found archive: $file"
          echo "archive=$file" >> $GITHUB_OUTPUT

      - name: Extract archive
        run: |
          mkdir -p unpacked
          if [[ "${{ steps.find.outputs.archive }}" == *.tar.gz ]]; then
            tar -xzf "${{ steps.find.outputs.archive }}" -C unpacked
          elif [[ "${{ steps.find.outputs.archive }}" == *.zip ]]; then
            unzip -o "${{ steps.find.outputs.archive }}" -d unpacked
          else
            echo "Unsupported archive type"
            exit 1
          fi
          echo "✅ Extracted contents:"
          ls -R unpacked

      - name: Detect project type
        id: detect
        run: |
          if compgen -G "unpacked/tests/*.py" > /dev/null; then
            echo "type=python" >> $GITHUB_OUTPUT
            echo "Detected Python tests."
          elif compgen -G "unpacked/test/*.js" > /dev/null; then
            echo "type=node" >> $GITHUB_OUTPUT
            echo "Detected Node tests."
          else
            echo "No recognized test files found."
            exit 1
          fi

      - name: Run Python tests
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        continue-on-error: false
      - name: Execute pytest
        if: steps.detect.outputs.type == 'python'
        run: |
          cd unpacked
          pip install pytest pytest-cov pytest-mock
          export PYTHONPATH="${GITHUB_WORKSPACE}:$PYTHONPATH"
          pytest -q --maxfail=1 --disable-warnings \
            --cov=. \
            --cov-report=xml:../coverage.xml \
            --cov-report=html:../coverage_html \
            --junitxml=../junit.xml
          echo "✅ Pytest run complete."

      - name: Run Node tests
        if: steps.detect.outputs.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
        continue-on-error: false
      - name: Execute vitest
        if: steps.detect.outputs.type == 'node'
        run: |
          cd unpacked
          npm install vitest
          npx vitest run --coverage
          echo "✅ Vitest run complete."

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage.xml
            junit.xml
            coverage/
            unpacked/coverage/
            coverage_html/
          if-no-files-found: ignore

  notify-n8n:
    if: always()
    needs: run-uploaded-tests
    runs-on: ubuntu-latest
    steps:
      - name: Notify n8n webhook
        run: |
          payload=$(jq -n \
            --arg status "${{ needs.run-uploaded-tests.result }}" \
            --arg conclusion "${{ job.status }}" \
            --arg repo "${{ github.repository }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg run_url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg sha "${{ github.sha }}" \
            '{status:$status, conclusion:$conclusion, repository:$repo, run_id:$run_id, run_url:$run_url, sha:$sha}')
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "https://test.omega.wizeline.io/webhook/2a2f3b97-3abc-4abb-9872-cbb78b8b5213"
